---
title: "Camcap Prostate Cancer"
author: "Mark Dunning"
date: "11 September 2015"
output:
  BiocStyle::html_document
---

In this document, I describe how the GEO data entry for the Varambally data was processed and saved into an object for analysis in Bioconductor. First of all load the relevant libraries for grabbing and manipulaing the data

```{r}
library(GEOquery)
library(dplyr)
library(tidyr)
library(org.Hs.eg.db)

```

Now use the `getGEO` function with the correct ID

```{r}

  url <- "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE70nnn/GSE70768/matrix/"
  destfile <-"GSE70768_series_matrix.txt.gz"
  
  if(!file.exists(destfile)){
  download.file(paste(url,destfile,sep=""),destfile=destfile)
  }
  
geoData <- getGEO(filename=destfile)
  
```  


We tidy up the data from GEO; creating a new data frame of just the clinical characteristics of interest.

```{r}

pd <- pData(geoData)
Group <- gsub("sample type: ", "", pd$characteristics_ch1)
Group[grep("CRPC",pd$title)] <- "CRPC"


pd2 <- data.frame("geo_accession" = pd$geo_accession, Sample = pd$description, Sample_Group = Group,Gleason=gsub("tumour gleason: ","",pd$characteristics_ch1.1), 
                            iCluster = gsub("(derived data) iclusterplus group: ","",pd$characteristics_ch1.3,fixed=TRUE),ECE=gsub("extra-capsular extension (ece): ","",pd$characteristics_ch1.4,fixed=TRUE),PSM = gsub("positive surgical margins (psm): ","",pd$characteristics_ch1.5,fixed=TRUE),BCR = gsub("biochemical relapse (bcr): ","",pd$characteristics_ch1.6,fixed=TRUE),
                            Time = gsub("time to bcr (months): ","",pd$characteristics_ch1.7,fixed=TRUE),ERG = gsub("tmprss2: ERG gene fusion status: ","",pd$characteristics_ch1.8,fixed=TRUE))

pd2$iCluster <- gsub("N/A", NA, pd2$iCluster)
pd2$iCluster[which(pd2$iCluster == "")] <- NA

pd2$Gleason <- gsub("N/A", NA, pd2$Gleason)

pd2$ECE <- gsub("unknown",NA,pd2$ECE)
pd2$ECE[which(pd2$ECE == "")] <- NA

pd2$PSM <- gsub("unknown",NA,pd2$PSM)
pd2$PSM[which(pd2$PSM == "")] <- NA

pd2$BCR <- gsub("N/A", NA, pd2$BCR)
pd2$BCR[which(pd2$BCR == "")] <- NA

pd2$Time <- gsub("N/A", NA, pd2$Time)
pd2$Time[which(pd2$Time == "")] <- NA


rownames(pd2) <- pd2$geo_accession

```

Replace the pheno data of the object and save

```{r}
         
pData(geoData) <- pd2
camcap <- geoData
save(camcap, file="../data/camcap.rda")

```

